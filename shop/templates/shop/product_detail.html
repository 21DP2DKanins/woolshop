{% extends 'shop/base.html' %}
{% load static %}

{% block title %}{{ product.name }} – Магазин{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
  <!-- Breadcrumbs -->
  <div class="text-sm text-gray-600 mb-8">
    <a href="{% url 'home' %}" class="hover:text-gray-900">Home</a> /
    <a href="{% url 'collection' %}" class="hover:text-gray-900">Shop</a> /
    <span>{{ product.name }}</span>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
    <!-- Product Images -->
    <div>
      <img src="{{ product.image.url }}"
           alt="{{ product.name }}"
           class="w-full h-auto" id="main-image">
    </div>

    <!-- Product Info -->
    <div>
      <h1 class="text-2xl font-medium mb-2">{{ product.name }}</h1>
      <p class="text-xl text-gray-700 mb-6">{{ product.price }} ₽</p>

      <form id="add-to-cart-form">
        <!-- Цвет -->
  <div class="mb-6">
    <label for="color-select" class="block mb-2 font-medium">Цвет</label>
    <select id="color-select" class="w-full border border-gray-300 p-2">
      <option value="">— выберите цвет —</option>
      {% for code,label in available_colors %}
      <option value="{{ code }}">{{ label }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- Размер -->
  <div class="mb-6">
    <label for="size-select" class="block mb-2 font-medium">Размер</label>
    <select id="size-select" class="w-full border border-gray-300 p-2" disabled>
      <option value="">— выберите размер —</option>
    </select>
  </div>

        <!-- Остаток -->
        <div id="stock-info" class="text-sm text-gray-600 mb-6" style="display:none;">
          В наличии: <span id="stock-count"></span>
        </div>

        <!-- Количество -->
        <div class="mb-6 flex items-center space-x-2">
          <button type="button" id="decrease-qty" class="px-3 py-1 border">−</button>
          <input type="number" id="quantity-input" value="1" min="1" disabled class="w-16 text-center border">
          <button type="button" id="increase-qty" class="px-3 py-1 border">+</button>
        </div>

        <!-- Добавить в корзину -->
        <button type="submit"
                id="add-to-cart-btn"
                class="w-full btn-primary disabled:opacity-50"
                disabled>Добавить в корзину</button>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const variants = [
    {% for v in variants %}
      { id: {{ v.id }}, color: "{{ v.color }}", size: "{{ v.size }}", stock: {{ v.stock }} },
    {% endfor %}
  ];

  const colorSelect = document.getElementById('color-select');
  const sizeSelect  = document.getElementById('size-select');
  const qtyInput    = document.getElementById('quantity-input');
  const stockInfo   = document.getElementById('stock-info');
  const stockCount  = document.getElementById('stock-count');
  const addBtn      = document.getElementById('add-to-cart-btn');
  const decBtn      = document.getElementById('decrease-qty');
  const incBtn      = document.getElementById('increase-qty');
  let currentStock = 0;
  let currentVid   = null;

  // При выборе цвета — заполняем размеры
  colorSelect.addEventListener('change', () => {
    sizeSelect.innerHTML = '<option value="">— выберите размер —</option>';
    sizeSelect.disabled = !colorSelect.value;
    stockInfo.style.display = 'none';
    qtyInput.disabled = true;
    addBtn.disabled = true;

    if (!colorSelect.value) return;

    const sizes = [...new Set(
      variants.filter(v => v.color === colorSelect.value)
              .map(v => v.size)
    )];

    sizes.forEach(sz => {
      const opt = document.createElement('option');
      opt.value = sz;
      opt.textContent = sz;
      sizeSelect.append(opt);
    });
  });

  // При выборе размера — показываем остаток
  sizeSelect.addEventListener('change', () => {
    if (!sizeSelect.value) {
      stockInfo.style.display = 'none';
      qtyInput.disabled = true;
      addBtn.disabled = true;
      return;
    }
    const sel = variants.find(v =>
      v.color === colorSelect.value && v.size === sizeSelect.value
    );
    currentStock = sel.stock;
    currentVid   = sel.id;
    stockCount.textContent = currentStock;
    stockInfo.style.display = 'block';
    qtyInput.max = currentStock;
    qtyInput.value = 1;
    qtyInput.disabled = false;
    addBtn.disabled = false;
  });

  // Изменение количества
  decBtn.addEventListener('click', () => {
    let v = parseInt(qtyInput.value,10);
    if (v > 1) qtyInput.value = v - 1;
  });
  incBtn.addEventListener('click', () => {
    let v = parseInt(qtyInput.value,10);
    if (v < currentStock) qtyInput.value = v + 1;
  });

  // Добавление в localStorage
  document.getElementById('add-to-cart-form').addEventListener('submit', e => {
    e.preventDefault();
    const cart = JSON.parse(localStorage.getItem('cart')||'[]');
    const item = {
      productId: {{ product.id }},
      variantId: currentVid,
      name: "{{ product.name|escapejs }}",
      price: {{ product.price }},
      image: "{{ product.image.url }}",
      color: colorSelect.options[colorSelect.selectedIndex].text,
      size: sizeSelect.value,
      quantity: parseInt(qtyInput.value,10),
      stock: currentStock,
    };
    const idx = cart.findIndex(x => x.variantId === item.variantId);
    if (idx > -1) {
      cart[idx].quantity = Math.min(cart[idx].quantity + item.quantity, currentStock);
    } else {
      cart.push(item);
    }
    localStorage.setItem('cart', JSON.stringify(cart));
    alert('Товар добавлен в корзину');
  });
});
</script>
{% endblock %}
