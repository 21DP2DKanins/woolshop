{% extends 'shop/base.html' %}

{% block title %}Shopping Cart - Life Etc.{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-2xl font-medium text-center mb-8">Shopping Cart</h1>

    <div id="cart-container">
        <!-- Контент будет сгенерирован JS -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Получаем корзину
    function getCart() {
        return JSON.parse(localStorage.getItem('cart') || '[]');
    }
    // Сохраняем корзину
    function saveCart(cart) {
        localStorage.setItem('cart', JSON.stringify(cart));
    }
    // Пересчёт суммы
    function calcTotals(cart) {
        const subtotal = cart.reduce((sum, i) => sum + i.price * i.quantity, 0);
        return { subtotal, total: subtotal }; // при необходимости добавьте доставку/скидки
    }
    // Отрисовка корзины
    function renderCart() {
        const cart = getCart();
        const container = document.getElementById('cart-container');
        if (cart.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12">
                    <p class="text-lg text-gray-600 mb-6">Your cart is empty</p>
                    <a href="/" class="btn-primary">Continue Shopping</a>
                </div>`;
            return;
        }
        // Основная верстка
        const { subtotal, total } = calcTotals(cart);
        let html = `
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-4">`;
        cart.forEach((item, idx) => {
            html += `
                <div class="flex items-center border-b pb-4">
                    <img src="${item.image}" alt="${item.name}" class="w-20 h-20 object-cover rounded">
                    <div class="ml-4 flex-1">
                        <h3 class="font-medium">${item.name}</h3>
                        <p class="text-gray-600">$${item.price.toFixed(2)}</p>
                        <button class="text-sm text-red-500 remove-item mt-1" data-index="${idx}">Remove</button>
                    </div>
                    <div class="flex items-center">
                        <button class="quantity-btn px-2" data-action="decrease" data-index="${idx}">-</button>
                        <input type="number" min="1" value="${item.quantity}" class="w-12 mx-2 text-center quantity-input" data-index="${idx}">
                        <button class="quantity-btn px-2" data-action="increase" data-index="${idx}">+</button>
                    </div>
                    <div class="w-24 text-right font-medium">
                        $${(item.price * item.quantity).toFixed(2)}
                    </div>
                </div>`;
        });
        html += `</div>
            <!-- Сайдбар с итогами -->
            <div class="lg:col-span-1 bg-gray-50 p-6">
                <h2 class="text-lg font-medium mb-4">Order Summary</h2>
                <div class="space-y-2 mb-4">
                    <div class="flex justify-between"><span>Subtotal</span><span id="cart-subtotal">$${subtotal.toFixed(2)}</span></div>
                    <div class="flex justify-between"><span>Shipping</span><span>Calculated at checkout</span></div>
                </div>
                <div class="border-t pt-4 mb-6">
                    <div class="flex justify-between font-medium"><span>Total</span><span id="cart-total">$${total.toFixed(2)}</span></div>
                </div>
                <a href="/" class="block w-full btn-primary text-center mb-4">Checkout</a>
                <a href="/" class="block w-full btn text-center">Continue Shopping</a>
            </div>
        </div>`;
        container.innerHTML = html;

        // Навешиваем события на кнопки
        document.querySelectorAll('.remove-item').forEach(btn => {
            btn.addEventListener('click', () => {
                const idx = +btn.dataset.index;
                cart.splice(idx, 1);
                saveCart(cart);
                renderCart();
            });
        });
        document.querySelectorAll('.quantity-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const idx = +btn.dataset.index;
                const action = btn.dataset.action;
                if (action === 'increase') cart[idx].quantity++;
                else if (action === 'decrease' && cart[idx].quantity > 1) cart[idx].quantity--;
                saveCart(cart);
                renderCart();
            });
        });
        document.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('change', () => {
                const idx = +input.dataset.index;
                let val = parseInt(input.value);
                if (isNaN(val) || val < 1) val = 1;
                cart[idx].quantity = val;
                saveCart(cart);
                renderCart();
            });
        });
    }

    renderCart();
});
</script>
{% endblock %}
